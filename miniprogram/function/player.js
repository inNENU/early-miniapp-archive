"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var wxpage_1 = require("wxpage");
var component_1 = require("../utils/component");
var file_1 = require("../utils/file");
var setpage_1 = require("../utils/setpage");
var wx_1 = require("../utils/wx");
var a = getApp().globalData;
var manager = wx.getBackgroundAudioManager();
wxpage_1.default('music', {
    data: {
        canplay: false,
        currentTime: 0,
        songLength: 1,
        currentSong: {},
        songListDisplay: false
    },
    onNavigate: function () {
        var songList = file_1.default.readJson('function/song');
        if (!songList)
            wx_1.default.request('function/song', function (data) {
                file_1.default.writeJson('function', 'song', data);
            });
    },
    onLoad: function (option) {
        var _this = this;
        wx.loadFontFace({
            family: 'FZSSJW', source: 'url("https://mp.nenuyouth.com/fonts/FZSSJW.ttf")',
            complete: function (res) {
                console.log('宋体字体', res);
            }
        });
        var currentSong;
        if (option.index)
            a.music.index = option.index;
        var index = a.music.index;
        var songList = file_1.default.readJson('function/song');
        var mode = wx.getStorageSync('playMode');
        this.setData({
            share: option.share ? option.share : false,
            index: index,
            info: a.info,
            nm: a.nm,
            play: a.music.play,
            mode: mode ? mode : (wx.setStorageSync('playMode', 0), 0)
        });
        if (songList) {
            currentSong = songList[index];
            this.setData({ songList: songList, currentSong: currentSong });
            if (a.music.played)
                this.setData({ canplay: true });
            else {
                manager.epname = 'NenuYouth';
                manager.src = currentSong.src;
                manager.title = currentSong.title;
                manager.singer = currentSong.singer;
                manager.coverImgUrl = currentSong.cover;
            }
        }
        else
            wx_1.default.request('function/song', function (data) {
                currentSong = data[index];
                _this.setData({ songList: data, currentSong: currentSong });
                if (a.music.played)
                    _this.setData({ canplay: true });
                else {
                    manager.epname = 'NenuYouth';
                    manager.src = currentSong.src;
                    manager.title = currentSong.title;
                    manager.singer = currentSong.singer;
                    manager.coverImgUrl = currentSong.cover;
                }
                file_1.default.writeJson('function', 'song', data);
            });
        manager.onCanplay(function () {
            setTimeout(function () {
                console.log('Canplay');
                _this.setData({ canplay: true });
            }, 100);
        });
        manager.onPlay(function () {
            _this.setData({ play: true });
            a.music.play = true;
        });
        manager.onPause(function () {
            _this.setData({ play: false });
            a.music.play = false;
        });
        manager.onTimeUpdate(function () {
            var presentSecond = Math.round(manager.currentTime % 60).toString();
            var totalSecond = Math.round(manager.duration % 60).toString();
            _this.setData({
                songLength: Math.round(manager.duration * 100) / 100,
                total: [
                    Math.round(manager.duration / 60).toString(),
                    totalSecond.length === 1 ? "0" + totalSecond : totalSecond
                ],
                currentTime: Math.round(manager.currentTime * 100) / 100,
                present: [
                    Math.round(manager.currentTime / 60).toString(),
                    presentSecond.length === 1 ? "0" + presentSecond : presentSecond
                ],
                bufferedTime: manager.buffered,
                canplay: true
            });
            a.music.played = true;
        });
        manager.onWaiting(function () {
            console.warn('waiting');
            _this.setData({ canplay: false });
        });
        manager.onPrev(function () {
            _this.previous();
        });
        manager.onEnded(function () {
            _this.end();
        });
        manager.onNext(function () {
            _this.next();
        });
        manager.onError(function () {
            wx_1.default.tip('获取音乐出错，请稍后重试');
        });
        var _a = setpage_1.default.color(false), nc = _a.nc, bc = _a.bc;
        wx.setNavigationBarColor(nc);
        wx.setBackgroundColor(bc);
        setpage_1.default.Notice('music');
    },
    loadCover: function (event) {
        if (event.type === 'load')
            this.setData({ coverLoad: true });
    },
    play: function () {
        if (this.data.play)
            manager.pause();
        else
            manager.play();
    },
    drag: function (event) {
        manager.seek(event.detail.value / 100);
        if (event.type === 'change') {
            this.setData({ currentTime: event.detail.value / 100 });
            console.log(event.detail.value);
        }
    },
    end: function () {
        var index = this.data.index;
        var total = this.data.songList.length;
        switch (this.data.mode) {
            case 3:
                var temp = void 0;
                do
                    temp = Math.round(Math.random() * total - 0.5);
                while (index === temp);
                index = temp;
                break;
            case 2:
                index = index + 1 === total ? 'stop' : index + 1;
                wx_1.default.tip('播放完毕');
                break;
            case 1:
                break;
            case 0:
            default: index = index + 1 === total ? 0 : index + 1;
        }
        this.Switch(index);
    },
    next: function () {
        var index = this.data.index;
        var total = this.data.songList.length;
        switch (this.data.mode) {
            case 3:
                var temp = void 0;
                do
                    temp = Math.round(Math.random() * total - 0.5);
                while (index === temp);
                index = temp;
                break;
            case 2:
                if (index + 1 === total) {
                    index = 'nothing';
                    wx_1.default.tip('已是最后一曲');
                }
                else
                    index += 1;
                break;
            case 1:
            case 0:
            default: index = index + 1 === total ? 0 : index + 1;
        }
        this.Switch(index);
    },
    previous: function () {
        var index = this.data.index;
        var total = this.data.songList.length;
        switch (this.data.mode) {
            case 3:
                var temp = void 0;
                do
                    temp = Math.round(Math.random() * total - 0.5);
                while (index === temp);
                index = temp;
                break;
            case 2:
                if (index === 0) {
                    index = 'nothing';
                    wx_1.default.tip('已是第一曲');
                }
                else
                    index -= 1;
                break;
            case 1:
            case 0:
            default: index = index === 0 ? total - 1 : index - 1;
        }
        this.Switch(index);
    },
    Switch: function (index) {
        if (index === 'stop') {
            this.setData({
                play: false,
                canPlay: false
            });
            manager.stop();
        }
        else if (index !== 'nothing') {
            var currentSong = this.data.songList[index];
            this.setData({
                index: index,
                currentSong: currentSong,
                play: false,
                canPlay: false
            });
            manager.src = currentSong.src;
            manager.title = currentSong.title;
            manager.singer = currentSong.singer;
            manager.coverImgUrl = currentSong.cover;
            a.music.index = index;
        }
    },
    modeSwitch: function () {
        var modeName;
        var mode = this.data.mode === 3 ? 0 : this.data.mode + 1;
        this.setData({ mode: mode });
        switch (mode) {
            case 1:
                modeName = '单曲循环';
                break;
            case 2:
                modeName = '顺序播放';
                break;
            case 3:
                modeName = '随机播放';
                break;
            case 0:
            default:
                modeName = '列表循环';
        }
        wx.setStorageSync('playMode', mode);
        wx_1.default.tip(modeName + "\u6A21\u5F0F");
    },
    list: function () {
        this.setData({ songListDisplay: !this.data.songListDisplay });
    },
    change: function (res) {
        this.list();
        this.Switch(res.currentTarget.dataset.index);
    },
    cA: function (e) {
        component_1.default.trigger(e, this);
    },
    onShareAppMessage: function () {
        return {
            title: this.data.title,
            path: "/function/player?index=" + this.data.index + "&share=true"
        };
    },
    redirect: function () {
        wx.switchTab({ url: '/page/main' });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicGxheWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBT0EsaUNBQStCO0FBQy9CLGdEQUE0QztBQUM1QyxzQ0FBa0M7QUFDbEMsNENBQXFDO0FBQ3JDLGtDQUE4QjtBQUN0QixJQUFBLHVCQUFhLENBQWM7QUFDbkMsSUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDLHlCQUF5QixFQUFFLENBQUM7QUFFL0MsZ0JBQVMsQ0FBQyxPQUFPLEVBQUU7SUFDakIsSUFBSSxFQUFFO1FBQ0osT0FBTyxFQUFFLEtBQUs7UUFDZCxXQUFXLEVBQUUsQ0FBQztRQUNkLFVBQVUsRUFBRSxDQUFDO1FBQ2IsV0FBVyxFQUFFLEVBQUU7UUFDZixlQUFlLEVBQUUsS0FBSztLQUN2QjtJQUNELFVBQVUsRUFBVjtRQUNFLElBQU0sUUFBUSxHQUFHLGNBQUssQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFakQsSUFBSSxDQUFDLFFBQVE7WUFBRSxZQUFHLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxVQUFDLElBQVM7Z0JBRXBELGNBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM1QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRCxNQUFNLEVBQU4sVUFBTyxNQUFXO1FBQWxCLGlCQWtKQztRQWhKQyxFQUFFLENBQUMsWUFBWSxDQUFDO1lBQ2QsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsa0RBQWtEO1lBQzVFLFFBQVEsRUFBRSxVQUFBLEdBQUc7Z0JBQ1gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDM0IsQ0FBQztTQUNGLENBQUMsQ0FBQztRQUVILElBQUksV0FBVyxDQUFDO1FBRWhCLElBQUksTUFBTSxDQUFDLEtBQUs7WUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxN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LEdBQUcsTUFBTSxDQUFDO2dCQUN4QixNQUFNO1lBQ1IsS0FBSyxDQUFDLENBQUM7WUFDUDtnQkFDRSxRQUFRLEdBQUcsTUFBTSxDQUFDO1NBQ3JCO1FBQ0QsRUFBRSxDQUFDLGNBQWMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEMsWUFBRyxDQUFDLEdBQUcsQ0FBSSxRQUFRLGlCQUFJLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBQ0QsSUFBSSxFQUFKO1FBQ0UsSUFBSSxDQUFDLE9BQVEsQ0FBQyxFQUFFLGVBQWUsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBQ0QsTUFBTSxFQUFOLFVBQU8sR0FBUTtRQUNiLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUNELEVBQUUsRUFBRixVQUFHLENBQU07UUFDUCxtQkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUNELGlCQUFpQjtRQUNmLE9BQU87WUFDTCxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLO1lBQ3RCLElBQUksRUFBRSw0QkFBMEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLGdCQUFhO1NBQzdELENBQUM7SUFDSixDQUFDO0lBQ0QsUUFBUTtRQUNOLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBBdXRob3I6IE1yLkhvcGVcbiAqIEBEYXRlOiAyMDE5LTA2LTI0IDIxOjIwOjU3XG4gKiBATGFzdEVkaXRvcnM6IE1yLkhvcGVcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMDYtMjQgMjM6NTc6NTFcbiAqIEBEZXNjcmlwdGlvbjog6Z+z5LmQ5pKt5pS+5ZmoXG4gKi9cbmltcG9ydCAkcmVnaXN0ZXIgZnJvbSAnd3hwYWdlJztcbmltcG9ydCAkY29tcG9uZW50IGZyb20gJy4uL3V0aWxzL2NvbXBvbmVudCc7XG5pbXBvcnQgJGZpbGUgZnJvbSAnLi4vdXRpbHMvZmlsZSc7XG5pbXBvcnQgJHBhZ2UgZnJvbSAnLi4vdXRpbHMvc2V0cGFnZSc7XG5pbXBvcnQgJG15IGZyb20gJy4uL3V0aWxzL3d4JztcbmNvbnN0IHsgZ2xvYmFsRGF0YTogYSB9ID0gZ2V0QXBwKCk7XG5jb25zdCBtYW5hZ2VyID0gd3guZ2V0QmFja2dyb3VuZEF1ZGlvTWFuYWdlcigpO1xuXG4kcmVnaXN0ZXIoJ211c2ljJywge1xuICBkYXRhOiB7XG4gICAgY2FucGxheTogZmFsc2UsXG4gICAgY3VycmVudFRpbWU6IDAsXG4gICAgc29uZ0xlbmd0aDogMSxcbiAgICBjdXJyZW50U29uZzoge30sXG4gICAgc29uZ0xpc3REaXNwbGF5OiBmYWxzZVxuICB9LFxuICBvbk5hdmlnYXRlKCkge1xuICAgIGNvbnN0IHNvbmdMaXN0ID0gJGZpbGUucmVhZEpzb24oJ2Z1bmN0aW9uL3NvbmcnKTtcblxuICAgIGlmICghc29uZ0xpc3QpICRteS5yZXF1ZXN0KCdmdW5jdGlvbi9zb25nJywgKGRhdGE6IGFueSkgPT4ge1xuICAgICAgLy8g5YaZ5YWlSlNPTuaWh+S7tlxuICAgICAgJGZpbGUud3JpdGVKc29uKCdmdW5jdGlvbicsICdzb25nJywgZGF0YSk7XG4gICAgfSk7XG4gIH0sXG4gIG9uTG9hZChvcHRpb246IGFueSkge1xuICAgIC8vIOWKoOi9veWtl+S9k1xuICAgIHd4LmxvYWRGb250RmFjZSh7XG4gICAgICBmYW1pbHk6ICdGWlNTSlcnLCBzb3VyY2U6ICd1cmwoXCJodHRwczovL21wLm5lbnV5b3V0aC5jb20vZm9udHMvRlpTU0pXLnR0ZlwiKScsXG4gICAgICBjb21wbGV0ZTogcmVzID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ+Wui+S9k+Wtl+S9kycsIHJlcyk7IC8vIOiwg+ivlVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgbGV0IGN1cnJlbnRTb25nO1xuXG4gICAgaWYgKG9wdGlvbi5pbmRleCkgYS5tdXNpYy5pbmRleCA9IG9wdGlvbi5pbmRleDtcblxuICAgIGNvbnN0IHsgaW5kZXggfSA9IGEubXVzaWM7XG4gICAgY29uc3Qgc29uZ0xpc3QgPSAkZmlsZS5yZWFkSnNvbignZnVuY3Rpb24vc29uZycpO1xuICAgIGNvbnN0IG1vZGUgPSB3eC5nZXRTdG9yYWdlU3luYygncGxheU1vZGUnKTtcblxuICAgIC8vIOWGmeWFpeWfuuacrOS/oeaBr1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgc2hhcmU6IG9wdGlvbi5zaGFyZSA/IG9wdGlvbi5zaGFyZSA6IGZhbHNlLFxuICAgICAgaW5kZXgsXG4gICAgICBpbmZvOiBhLmluZm8sXG4gICAgICBubTogYS5ubSxcbiAgICAgIHBsYXk6IGEubXVzaWMucGxheSxcbiAgICAgIG1vZGU6IG1vZGUgPyBtb2RlIDogKHd4LnNldFN0b3JhZ2VTeW5jKCdwbGF5TW9kZScsIDApLCAwKVxuICAgIH0pO1xuXG5cbiAgICBpZiAoc29uZ0xpc3QpIHtcbiAgICAgIC8vIOWGmeWFpeatjOabsuWIl+ihqOS4juW9k+WJjeatjOabsuS/oeaBr1xuICAgICAgY3VycmVudFNvbmcgPSBzb25nTGlzdFtpbmRleF07XG4gICAgICB0aGlzLnNldERhdGEhKHsgc29uZ0xpc3QsIGN1cnJlbnRTb25nIH0pO1xuXG4gICAgICAvLyDlpoLmnpzmraPlnKjmkq3mlL7vvIzorr7nva7og73lpJ/mkq3mlL5cbiAgICAgIGlmIChhLm11c2ljLnBsYXllZCkgdGhpcy5zZXREYXRhISh7IGNhbnBsYXk6IHRydWUgfSk7XG5cbiAgICAgIC8vIOWvuemfs+mikeeuoeeQhuWZqOi/m+ihjOiuvue9rlxuICAgICAgZWxzZSB7XG4gICAgICAgIG1hbmFnZXIuZXBuYW1lID0gJ05lbnVZb3V0aCc7XG4gICAgICAgIG1hbmFnZXIuc3JjID0gY3VycmVudFNvbmcuc3JjO1xuICAgICAgICBtYW5hZ2VyLnRpdGxlID0gY3VycmVudFNvbmcudGl0bGU7XG4gICAgICAgIG1hbmFnZXIuc2luZ2VyID0gY3VycmVudFNvbmcuc2luZ2VyO1xuICAgICAgICBtYW5hZ2VyLmNvdmVySW1nVXJsID0gY3VycmVudFNvbmcuY292ZXI7XG4gICAgICB9XG5cbiAgICAgIC8vIOWcqOe6v+iOt+WPluatjOabsuWIl+ihqFxuICAgIH0gZWxzZSAkbXkucmVxdWVzdCgnZnVuY3Rpb24vc29uZycsIChkYXRhOiBhbnkpID0+IHtcbiAgICAgIGN1cnJlbnRTb25nID0gZGF0YVtpbmRleF07XG4gICAgICB0aGlzLnNldERhdGEhKHsgc29uZ0xpc3Q6IGRhdGEsIGN1cnJlbnRTb25nIH0pO1xuXG4gICAgICAvLyDlpoLmnpzmraPlnKjmkq3mlL7vvIzorr7nva7og73lpJ/mkq3mlL5cbiAgICAgIGlmIChhLm11c2ljLnBsYXllZCkgdGhpcy5zZXREYXRhISh7IGNhbnBsYXk6IHRydWUgfSk7XG5cbiAgICAgIC8vIOWvuemfs+mikeeuoeeQhuWZqOi/m+ihjOiuvue9rlxuICAgICAgZWxzZSB7XG4gICAgICAgIG1hbmFnZXIuZXBuYW1lID0gJ05lbnVZb3V0aCc7XG4gICAgICAgIG1hbmFnZXIuc3JjID0gY3VycmVudFNvbmcuc3JjO1xuICAgICAgICBtYW5hZ2VyLnRpdGxlID0gY3VycmVudFNvbmcudGl0bGU7XG4gICAgICAgIG1hbmFnZXIuc2luZ2VyID0gY3VycmVudFNvbmcuc2luZ2VyO1xuICAgICAgICBtYW5hZ2VyLmNvdmVySW1nVXJsID0gY3VycmVudFNvbmcuY292ZXI7XG4gICAgICB9XG5cbiAgICAgIC8vIOWGmeWFpUpTT07mlofku7ZcbiAgICAgICRmaWxlLndyaXRlSnNvbignZnVuY3Rpb24nLCAnc29uZycsIGRhdGEpO1xuICAgIH0pO1xuXG4gICAgLy/jgIDog73lpJ/mkq3mlL4xMDBtc+WQjuiuvue9ruWPr+S7peaSreaUvlxuICAgIG1hbmFnZXIub25DYW5wbGF5KCgpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnQ2FucGxheScpOyAvLyDosIPor5VcbiAgICAgICAgdGhpcy5zZXREYXRhISh7IGNhbnBsYXk6IHRydWUgfSk7XG4gICAgICB9LCAxMDApXG4gICAgfSk7XG5cbiAgICAvLyDlnKjnm7jlupTliqjkvZzml7bmlLnlj5jnirbmgIFcbiAgICBtYW5hZ2VyLm9uUGxheSgoKSA9PiB7XG4gICAgICB0aGlzLnNldERhdGEhKHsgcGxheTogdHJ1ZSB9KTtcbiAgICAgIGEubXVzaWMucGxheSA9IHRydWU7XG4gICAgfSk7XG5cbiAgICBtYW5hZ2VyLm9uUGF1c2UoKCkgPT4ge1xuICAgICAgdGhpcy5zZXREYXRhISh7IHBsYXk6IGZhbHNlIH0pO1xuICAgICAgYS5tdXNpYy5wbGF5ID0gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBtYW5hZ2VyLm9uVGltZVVwZGF0ZSgoKSA9PiB7XG5cbiAgICAgIC8qXG4gICAgICAgKiDosIPor5VcbiAgICAgICAqIGNvbnNvbGUubG9nKGBUaW1lVXBkYXRlLGN1cnJlbnRUaW1l5pivJHttYW5hZ2VyLmN1cnJlbnRUaW1lfWApO1xuICAgICAgICogY29uc29sZS5sb2coYGJ1ZmZlcmVkVGltZeaYryR7bWFuYWdlci5idWZmZXJlZH0sZHVyYXRpb27mmK8ke21hbmFnZXIuZHVyYXRpb259YCk7XG4gICAgICAgKi9cblxuICAgICAgY29uc3QgcHJlc2VudFNlY29uZCA9IE1hdGgucm91bmQobWFuYWdlci5jdXJyZW50VGltZSAlIDYwKS50b1N0cmluZygpO1xuICAgICAgY29uc3QgdG90YWxTZWNvbmQgPSBNYXRoLnJvdW5kKG1hbmFnZXIuZHVyYXRpb24gJSA2MCkudG9TdHJpbmcoKTtcblxuICAgICAgLy8g5pu05paw5q2M5puy5L+h5oGvXG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgc29uZ0xlbmd0aDogTWF0aC5yb3VuZChtYW5hZ2VyLmR1cmF0aW9uICogMTAwKSAvIDEwMCxcbiAgICAgICAgdG90YWw6IFtcbiAgICAgICAgICBNYXRoLnJvdW5kKG1hbmFnZXIuZHVyYXRpb24gLyA2MCkudG9TdHJpbmcoKSxcbiAgICAgICAgICB0b3RhbFNlY29uZC5sZW5ndGggPT09IDEgPyBgMCR7dG90YWxTZWNvbmR9YCA6IHRvdGFsU2Vjb25kXG4gICAgICAgIF0sXG4gICAgICAgIGN1cnJlbnRUaW1lOiBNYXRoLnJvdW5kKG1hbmFnZXIuY3VycmVudFRpbWUgKiAxMDApIC8gMTAwLFxuICAgICAgICBwcmVzZW50OiBbXG4gICAgICAgICAgTWF0aC5yb3VuZChtYW5hZ2VyLmN1cnJlbnRUaW1lIC8gNjApLnRvU3RyaW5nKCksXG4gICAgICAgICAgcHJlc2VudFNlY29uZC5sZW5ndGggPT09IDEgPyBgMCR7cHJlc2VudFNlY29uZH1gIDogcHJlc2VudFNlY29uZFxuICAgICAgICBdLFxuICAgICAgICBidWZmZXJlZFRpbWU6IG1hbmFnZXIuYnVmZmVyZWQsXG4gICAgICAgIGNhbnBsYXk6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgICAvLyDorr7nva7mkq3mlL7nirbmgIFcbiAgICAgIGEubXVzaWMucGxheWVkID0gdHJ1ZTtcbiAgICB9KTtcblxuICAgIC8vIOe8k+WGsuS4rVxuICAgIG1hbmFnZXIub25XYWl0aW5nKCgpID0+IHtcbiAgICAgIGNvbnNvbGUud2Fybignd2FpdGluZycpO1xuICAgICAgdGhpcy5zZXREYXRhISh7IGNhbnBsYXk6IGZhbHNlIH0pO1xuICAgIH0pO1xuXG4gICAgbWFuYWdlci5vblByZXYoKCkgPT4ge1xuICAgICAgdGhpcy5wcmV2aW91cygpO1xuICAgIH0pO1xuXG4gICAgLy8g5q2M5puy5pKt5pS+57uT5p2fXG4gICAgbWFuYWdlci5vbkVuZGVkKCgpID0+IHtcbiAgICAgIHRoaXMuZW5kKCk7XG4gICAgfSk7XG5cbiAgICBtYW5hZ2VyLm9uTmV4dCgoKSA9PiB7XG4gICAgICB0aGlzLm5leHQoKTtcbiAgICB9KTtcblxuICAgIG1hbmFnZXIub25FcnJvcigoKSA9PiB7XG4gICAgICAkbXkudGlwKCfojrflj5bpn7PkuZDlh7rplJnvvIzor7fnqI3lkI7ph43or5UnKTtcbiAgICB9KTtcblxuICAgIC8vIOiuvue9ruiDtuWbiuWSjOiDjOaZr+minOiJslxuICAgIGNvbnN0IHsgbmMsIGJjIH0gPSAkcGFnZS5jb2xvcihmYWxzZSk7XG5cbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyQ29sb3IobmMpO1xuICAgIHd4LnNldEJhY2tncm91bmRDb2xvcihiYyk7XG5cbiAgICAkcGFnZS5Ob3RpY2UoJ211c2ljJyk7XG4gIH0sXG4gIGxvYWRDb3ZlcihldmVudDogYW55KSB7IC8vIOWKoOi9veWwgemdolxuICAgIGlmIChldmVudC50eXBlID09PSAnbG9hZCcpIHRoaXMuc2V0RGF0YSEoeyBjb3ZlckxvYWQ6IHRydWUgfSk7XG4gIH0sXG4gIHBsYXkoKSB7IC8vIOaSreaUvlxuICAgIGlmICh0aGlzLmRhdGEucGxheSkgbWFuYWdlci5wYXVzZSgpO1xuICAgIGVsc2UgbWFuYWdlci5wbGF5KCk7XG4gIH0sXG4gIGRyYWcoZXZlbnQ6IGFueSkgeyAvLyDmi5bmi73ov5vluqZcbiAgICBtYW5hZ2VyLnNlZWsoZXZlbnQuZGV0YWlsLnZhbHVlIC8gMTAwKTtcbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2NoYW5nZScpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSEoeyBjdXJyZW50VGltZTogZXZlbnQuZGV0YWlsLnZhbHVlIC8gMTAwIH0pO1xuICAgICAgY29uc29sZS5sb2coZXZlbnQuZGV0YWlsLnZhbHVlKTsgLy8g6LCD6K+VXG4gICAgfVxuICB9LFxuICBlbmQoKSB7IC8vIOe7k+adn+WKqOS9nFxuICAgIGxldCB7IGluZGV4IH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgdG90YWwgPSB0aGlzLmRhdGEuc29uZ0xpc3QubGVuZ3RoO1xuXG4gICAgc3dpdGNoICh0aGlzLmRhdGEubW9kZSkge1xuICAgICAgY2FzZSAzOlxuICAgICAgICBsZXQgdGVtcDtcblxuICAgICAgICBkbyB0ZW1wID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogdG90YWwgLSAwLjUpOyB3aGlsZSAoaW5kZXggPT09IHRlbXApO1xuICAgICAgICBpbmRleCA9IHRlbXA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICBpbmRleCA9IGluZGV4ICsgMSA9PT0gdG90YWwgPyAnc3RvcCcgOiBpbmRleCArIDE7XG4gICAgICAgICRteS50aXAoJ+aSreaUvuWujOavlScpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMTpcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDA6XG4gICAgICBkZWZhdWx0OiBpbmRleCA9IGluZGV4ICsgMSA9PT0gdG90YWwgPyAwIDogaW5kZXggKyAxO1xuICAgIH1cbiAgICB0aGlzLlN3aXRjaChpbmRleCk7XG4gIH0sXG4gIG5leHQoKSB7IC8vIOS4i+S4gOabsuWKqOS9nFxuICAgIGxldCB7IGluZGV4IH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgdG90YWwgPSB0aGlzLmRhdGEuc29uZ0xpc3QubGVuZ3RoO1xuXG4gICAgc3dpdGNoICh0aGlzLmRhdGEubW9kZSkge1xuICAgICAgY2FzZSAzOlxuICAgICAgICBsZXQgdGVtcDtcblxuICAgICAgICBkbyB0ZW1wID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogdG90YWwgLSAwLjUpOyB3aGlsZSAoaW5kZXggPT09IHRlbXApO1xuICAgICAgICBpbmRleCA9IHRlbXA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICBpZiAoaW5kZXggKyAxID09PSB0b3RhbCkge1xuICAgICAgICAgIGluZGV4ID0gJ25vdGhpbmcnO1xuICAgICAgICAgICRteS50aXAoJ+W3suaYr+acgOWQjuS4gOabsicpO1xuICAgICAgICB9IGVsc2UgaW5kZXggKz0gMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDE6XG4gICAgICBjYXNlIDA6XG4gICAgICBkZWZhdWx0OiBpbmRleCA9IGluZGV4ICsgMSA9PT0gdG90YWwgPyAwIDogaW5kZXggKyAxO1xuICAgIH1cbiAgICB0aGlzLlN3aXRjaChpbmRleCk7XG4gIH0sXG4gIHByZXZpb3VzKCkgeyAvLyDkuIrkuIDmm7LliqjkvZxcbiAgICBsZXQgeyBpbmRleCB9ID0gdGhpcy5kYXRhO1xuICAgIGNvbnN0IHsgbGVuZ3RoOiB0b3RhbCB9ID0gdGhpcy5kYXRhLnNvbmdMaXN0O1xuXG4gICAgc3dpdGNoICh0aGlzLmRhdGEubW9kZSkge1xuICAgICAgY2FzZSAzOlxuICAgICAgICBsZXQgdGVtcDtcblxuICAgICAgICBkbyB0ZW1wID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogdG90YWwgLSAwLjUpOyB3aGlsZSAoaW5kZXggPT09IHRlbXApO1xuICAgICAgICBpbmRleCA9IHRlbXA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAyOlxuICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICBpbmRleCA9ICdub3RoaW5nJztcbiAgICAgICAgICAkbXkudGlwKCflt7LmmK/nrKzkuIDmm7InKTtcbiAgICAgICAgfSBlbHNlIGluZGV4IC09IDE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxOlxuICAgICAgY2FzZSAwOlxuICAgICAgZGVmYXVsdDogaW5kZXggPSBpbmRleCA9PT0gMCA/IHRvdGFsIC0gMSA6IGluZGV4IC0gMTtcbiAgICB9XG4gICAgdGhpcy5Td2l0Y2goaW5kZXgpO1xuICB9LFxuICBTd2l0Y2goaW5kZXg6IGFueSkgeyAvLyDliIfmjaLmrYzmm7JcbiAgICBpZiAoaW5kZXggPT09ICdzdG9wJykge1xuXG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgcGxheTogZmFsc2UsXG4gICAgICAgIGNhblBsYXk6IGZhbHNlXG4gICAgICB9KTtcblxuICAgICAgbWFuYWdlci5zdG9wKCk7XG5cbiAgICB9IGVsc2UgaWYgKGluZGV4ICE9PSAnbm90aGluZycpIHvjgIAvLyDmraPluLjotYvlgLxcblxuICAgICAgY29uc3QgY3VycmVudFNvbmcgPSB0aGlzLmRhdGEuc29uZ0xpc3RbaW5kZXhdO1xuXG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGN1cnJlbnRTb25nLFxuICAgICAgICBwbGF5OiBmYWxzZSxcbiAgICAgICAgY2FuUGxheTogZmFsc2VcbiAgICAgIH0pO1xuXG4gICAgICBtYW5hZ2VyLnNyYyA9IGN1cnJlbnRTb25nLnNyYztcbiAgICAgIG1hbmFnZXIudGl0bGUgPSBjdXJyZW50U29uZy50aXRsZTtcbiAgICAgIG1hbmFnZXIuc2luZ2VyID0gY3VycmVudFNvbmcuc2luZ2VyO1xuICAgICAgbWFuYWdlci5jb3ZlckltZ1VybCA9IGN1cnJlbnRTb25nLmNvdmVyO1xuICAgICAgYS5tdXNpYy5pbmRleCA9IGluZGV4O1xuICAgIH1cbiAgfSxcbiAgbW9kZVN3aXRjaCgpIHsgLy8g5YiH5o2i5pKt5pS+5qih5byPXG4gICAgbGV0IG1vZGVOYW1lO1xuICAgIGNvbnN0IG1vZGUgPSB0aGlzLmRhdGEubW9kZSA9PT0gMyA/IDAgOiB0aGlzLmRhdGEubW9kZSArIDE7XG5cbiAgICB0aGlzLnNldERhdGEhKHsgbW9kZSB9KTtcbiAgICBzd2l0Y2ggKG1vZGUpIHtcbiAgICAgIGNhc2UgMTogbW9kZU5hbWUgPSAn5Y2V5puy5b6q546vJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6IG1vZGVOYW1lID0gJ+mhuuW6j+aSreaUvic7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzOiBtb2RlTmFtZSA9ICfpmo/mnLrmkq3mlL4nO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMDpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIG1vZGVOYW1lID0gJ+WIl+ihqOW+queOryc7XG4gICAgfVxuICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdwbGF5TW9kZScsIG1vZGUpO1xuICAgICRteS50aXAoYCR7bW9kZU5hbWV95qih5byPYCk7XG4gIH0sXG4gIGxpc3QoKSB7IC8vIOWIh+aNouWIl+ihqOaYvumakFxuICAgIHRoaXMuc2V0RGF0YSEoeyBzb25nTGlzdERpc3BsYXk6ICF0aGlzLmRhdGEuc29uZ0xpc3REaXNwbGF5IH0pO1xuICB9LFxuICBjaGFuZ2UocmVzOiBhbnkpIHsgLy8g54K55Ye75YiX6KGo5YW35L2T5q2M5puy6aG55pe26Kem5Y+RXG4gICAgdGhpcy5saXN0KCk7XG4gICAgdGhpcy5Td2l0Y2gocmVzLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbmRleCk7XG4gIH0sXG4gIGNBKGU6IGFueSkge1xuICAgICRjb21wb25lbnQudHJpZ2dlcihlLCB0aGlzKTtcbiAgfSxcbiAgb25TaGFyZUFwcE1lc3NhZ2UoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiB0aGlzLmRhdGEudGl0bGUsXG4gICAgICBwYXRoOiBgL2Z1bmN0aW9uL3BsYXllcj9pbmRleD0ke3RoaXMuZGF0YS5pbmRleH0mc2hhcmU9dHJ1ZWBcbiAgICB9O1xuICB9LFxuICByZWRpcmVjdCgpIHtcbiAgICB3eC5zd2l0Y2hUYWIoeyB1cmw6ICcvcGFnZS9tYWluJyB9KTtcbiAgfVxufSk7XG4iXX0=